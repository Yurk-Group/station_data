---
title: "Long term station data analysis"
author: "Brian Yurk"
date: "12/4/2020"
output: html_document
---

```{r setup, include=FALSE}
require("knitr")
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir=normalizePath("..")) #set working directory to the project directory
```

```{r}
rm(list=ls())
gc()
library(tidyverse)
library(lubridate)
library(ggplot2)
```

```{r}
compute_durations <- function(tib){
  tib <- tib %>% mutate(dt = as.duration(lag(datetime,1) %--% datetime)/dhours(1))
  return(tib)
}

compute_dpt <- function(tib){
  tib <- tib %>% mutate(dpt = dp*dt)
  return(tib)
}

compute_dpt2 <- function(tib,dtmax=3){
  tib <- tib %>% mutate(dpt2 = dp*pmin(dt,3),lost_dt = dt-pmin(dt,3))
  return(tib)
}

compute_dp_stuff <- function(tib,dtmax = 3){
  tib <- tib %>% drop_na(WS) %>% compute_durations() %>% compute_dpt() %>% compute_dpt2(dtmax)
  return(tib)
}

drop_yrs <- function(tib,yrs){
  tib <- tib[!(year(tib$datetime) %in% yrs),]
  return(tib)
}

compute_by_yr_stuff_directional <- function(tib){
  tib <- tib %>% select(datetime,dt,dp,WD,dpt,dpt2,lost_dt) %>% mutate(yr = year(datetime)) %>%
    group_by(yr) %>% 
    summarize(dp_m = mean(dp,na.rm=TRUE),dt_m=mean(dt,na.rm=TRUE),dt_sd=sd(dt,na.rm=TRUE),
              dpt_su=sum(dpt,na.rm=TRUE),dpt2_su=sum(dpt2,na.rm=TRUE),lost_dt_su=sum(lost_dt,na.rm=TRUE),
              dp_n = sum(dpt2*(WD>=0)*(WD<11.25)+dpt2*(WD>=348.75)*(WD<=360),na.rm=TRUE),
              dp_nne = sum(dpt2*(WD>=11.25)*(WD<33.75),na.rm=TRUE),
              dp_ne = sum(dpt2*(WD>=33.75)*(WD<56.25),na.rm=TRUE),
              dp_ene = sum(dpt2*(WD>=56.25)*(WD<78.75),na.rm=TRUE),
              dp_e = sum(dpt2*(WD>=78.75)*(WD<101.25),na.rm=TRUE),
              dp_ese = sum(dpt2*(WD>=101.25)*(WD<123.75),na.rm=TRUE),
              dp_se = sum(dpt2*(WD>=123.75)*(WD<146.25),na.rm=TRUE),
              dp_sse = sum(dpt2*(WD>=146.25)*(WD<168.75),na.rm=TRUE),
              dp_s = sum(dpt2*(WD>=168.75)*(WD<191.25),na.rm=TRUE),
              dp_ssw = sum(dpt2*(WD>=191.25)*(WD<213.75),na.rm=TRUE),
              dp_sw = sum(dpt2*(WD>=213.75)*(WD<236.25),na.rm=TRUE),
              dp_wsw = sum(dpt2*(WD>=236.25)*(WD<258.75),na.rm=TRUE),
              dp_w = sum(dpt2*(WD>=258.75)*(WD<281.25),na.rm=TRUE),
              dp_wnw = sum(dpt2*(WD>=281.25)*(WD<303.75),na.rm=TRUE),
              dp_nw = sum(dpt2*(WD>=303.75)*(WD<326.25),na.rm=TRUE),
              dp_nnw = sum(dpt2*(WD>=326.25)*(WD<348.75),na.rm=TRUE),
              dp_sc = sum(dpt2*(WD>=0)*(WD<=45)+dpt2*(WD>=315)*(WD<=360),na.rm=TRUE),
              dp_swc = sum(dpt2*(WD>=0)*(WD<=90)+dpt2*(WD==360),na.rm=TRUE),
              dp_wc = sum(dpt2*(WD>=45)*(WD<=135),na.rm=TRUE),
              dp_nwc = sum(dpt2*(WD>=90)*(WD<=180),na.rm=TRUE),
              dp_nc = sum(dpt2*(WD>=135)*(WD<=225),na.rm=TRUE),
              dp_nec = sum(dpt2*(WD>=180)*(WD<=270),na.rm=TRUE),
              dp_ec = sum(dpt2*(WD>=225)*(WD<=315),na.rm=TRUE),
              dp_sec = sum(dpt2*(WD>=270)*(WD<=360)+dpt2*(WD==0),na.rm=TRUE),
              nobs=n())
  return(tib)
}


drop_big_lost_dt_yrs<- function(tib,dtmax=175){
  tib <- tib[tib$lost_dt_su<=dtmax,]
  return(tib)
}


group_by_yrs <- function(tib,breaks){
  tib <- tib %>% group_by(gr=cut(yr,breaks=breaks,right=FALSE)) %>%
    summarize_at(vars(dpt2_su:nobs),sum,na.rm=TRUE)
  return(tib)
}

dp_plot <- function(dp,yscale=30){
  dir <- seq(0,360-22.5,by=22.5)
  ndp <- dp*cos(dir*pi/180) #north components of dp
  edp <- dp*sin(dir*pi/180) #east components of dp
  rndp <- sum(ndp) #north component of resultant dp
  redp <- sum(edp) #east component of resultant dp
  rdp <- sqrt(rndp^2+redp^2) #rdp magnitude
  rdir <- (atan2(redp,rndp)*180/pi+180) %% 360 #rdp direction (rotated 180 to point where the sand is going)
  
  dp_df <- structure(list(dir = dir, dp = dp),.Names=c("dir", "dp"),
                     class="data.frame",row.names=c(NA,-16) )
  
  rdp_df <- structure(list(dir = rdir, dp = rdp),.Names=c("dir", "dp"),
                      class="data.frame",row.names=c(17L) )
  
  #Set ylim to be as large as needed for largest dp in set of diagrams being displayed together. Then we get consistent scaling
  base <- ggplot(dp_df, aes(x=dir,y=dp))
  p <- base + coord_polar() + ylim(0,yscale) +
    scale_x_continuous(limits=c(0,360),breaks=dir)
  q <- p + geom_segment(data = dp_df , aes(y=0,xend=dir,yend=dp),col="black") +
    geom_segment(data = rdp_df , aes(y=0,xend=dir,yend=dp),
                 arrow=arrow(length=unit(0.3,"cm")),col="grey",size=1) +
    theme(axis.line=element_blank(),axis.text.x=element_blank(),
          axis.text.y=element_blank(),axis.ticks=element_blank(),
          axis.title.x=element_blank(),
          axis.title.y=element_blank(),legend.position="none",
          panel.background=element_blank(),panel.border=element_blank(),
          panel.grid.major=element_blank(),
          panel.grid.minor=element_blank(),plot.background=element_blank()) 
  print(q)
  return(q)
}


dp_plot_yrs <- function(tib,row,yscale=30,fname=NULL){
  st <- which(names(tib)=="dp_n")
  en <- which(names(tib)=="dp_nnw")
  dp <- as.numeric(tib[row,st:en])
  print(dp)
  print(str(dp))
  dp_plot(dp,yscale=yscale)
  if(!is.null(fname)){
    ggsave(fname,height = 3, width=3, units= "in")
  }
}
```

Import dp data for each station, drop rows with NA wind speeds, compute time intervals, compute drift potentials (q*dt, calling it dpt, dp is drift potential per time).

```{r}
beh <- readRDS('clean_data/BEH_19730101_20201207_dp.rds') %>% compute_dp_stuff() %>% drop_yrs(c(1973,1988,2020))
biv <- readRDS('clean_data/KBIV_19961231_20201203_dp.rds') %>% compute_dp_stuff() %>% drop_yrs(c(1996,2020))
grb <- readRDS('clean_data/GRB_19490901_20201207_dp.rds') %>% compute_dp_stuff() %>% drop_yrs(c(1949,2020))
mdw <- readRDS('clean_data/MDW_19480101_20201207_dp.rds') %>% compute_dp_stuff() %>% drop_yrs(c(2020))
mke <- readRDS('clean_data/MKE_19471231_20201207_dp.rds') %>% compute_dp_stuff() %>% drop_yrs(c(1947,2020))
mkg <- readRDS('clean_data/KMKG_19480101_20201204_dp.rds') %>% compute_dp_stuff() %>% drop_yrs(c(2020))
tvc <- readRDS('clean_data/TVC_19481201_20201207_dp.rds') %>% compute_dp_stuff() %>% drop_yrs(c(1948,2020))

station_list <- list(beh=beh,biv=biv,grb=grb,mdw=mdw,mke=mke,mkg=mkg,tvc=tvc)

##let's look at the lengths of runs of NA values in the wind speeds
#rle_ws <- rle(is.na(beh$WS))
#rl_ws <- rle_ws$lengths[rle_ws$values]
#rl_ws
#print(table(rl_ws))
```

The dpt2 variable only computes drift potentials for at most a 3 hour duration. If the gap between reports is larger, then dpt2 is dp*3 (just the first 3 hours), and the rest of the duration is ignored (0 dp during the rest). The lost_dt variable measures how much time is lost doing things this way. We will remove years from the data where this adds up to more than 175 hours (2% of the year). In some cases, stations seemed to stop reporting at night (see, e.g., early BEH data). These years will not be represented in the data. In other cases there were large gaps in the data. These years are also removed.


```{r}
lost_dt_max <- 175 #hrs
station_list_yr <- station_list %>% map(compute_by_yr_stuff_directional) %>%
  map(drop_big_lost_dt_yrs,dtmax=lost_dt_max)

#beh_yr_dir <- beh %>% compute_by_yr_stuff_directional() %>% drop_big_lost_dt_yrs(lost_dt_max)
#biv_yr_dir <- biv %>% compute_by_yr_stuff_directional() %>% drop_big_lost_dt_yrs(lost_dt_max)
#grb_yr_dir <- grb %>% compute_by_yr_stuff_directional() %>% drop_big_lost_dt_yrs(lost_dt_max)
#mdw_yr_dir <- mdw %>% compute_by_yr_stuff_directional() %>% drop_big_lost_dt_yrs(lost_dt_max)
#mke_yr_dir <- mke %>% compute_by_yr_stuff_directional() %>% drop_big_lost_dt_yrs(lost_dt_max)
#mkg_yr_dir <- mkg %>% compute_by_yr_stuff_directional() %>% drop_big_lost_dt_yrs(lost_dt_max)
#tvc_yr_dir <- tvc %>% compute_by_yr_stuff_directional() %>% drop_big_lost_dt_yrs(lost_dt_max)

#When doing decadal summaries, need to be mindful of missing years. Important if looking at dp totals, for example.
breaks <- seq(1948,2018,by=10)
station_list_dec <- station_list_yr %>% map(group_by_yrs,breaks=breaks)
```

```{r}
plot(beh_yr_dir$yr,beh_yr_d$dpt2_su,xlab='year',ylab='DP',pch=15,xlim=c(1948,2020),ylim=c(0,1e7),col="red")
points(biv_yr_dir$yr,biv_yr_dir$dpt2_su,xlab='year',ylab='DP',pch=16,col="orange")
points(grb_yr_dir$yr,grb_yr_dir$dpt2_su,xlab='year',ylab='DP',pch=17,col="magenta")
points(mdw_yr_dir$yr,mdw_yr_dir$dpt2_su,xlab='year',ylab='DP',pch=18,col="green")
points(mke_yr_dir$yr,mke_yr_dir$dpt2_su,xlab='year',ylab='DP',pch=19,col="blue")
points(mkg_yr_dir$yr,mkg_yr_dir$dpt2_su,xlab='year',ylab='DP',pch=3,col="purple")
points(tvc_yr_dir$yr,tvc_yr_dir$dpt2_su,xlab='year',ylab='DP',pch=8)
legend(2010,9.2e6,legend=c("BEH","BIV","GRB","MDW","MKE","MKG","TVC"), pch = c(15,16,17,18,19,3,8),col=c("red","orange","magenta","green","blue","purple","black"))
```



```{r}
#breaks <- seq(1948,2018,by=10)
#beh_dec <- beh_yr_dir %>% group_by_yrs(breaks)
#biv_dec <- biv_yr_dir %>% group_by_yrs(breaks)
#grb_dec <- grb_yr_dir %>% group_by_yrs(breaks)
#mdw_dec <- mdw_yr_dir %>% group_by_yrs(breaks)
#mke_dec <- mke_yr_dir %>% group_by_yrs(breaks)
#mkg_dec <- mkg_yr_dir %>% group_by_yrs(breaks)
#tvc_dec <- tvc_yr_dir %>% group_by_yrs(breaks)
```


```{r}
dp_plot_yrs(mkg_dec,1,yscale=2.7e7,fname="outputs/mkg_1948_1957.pdf")
dp_plot_yrs(mkg_dec,2,yscale=2.7e7,fname="outputs/mkg_1958_1967.pdf")
dp_plot_yrs(mkg_dec,3,yscale=2.7e7,fname="outputs/mkg_1968_1977.pdf")
dp_plot_yrs(mkg_dec,4,yscale=2.7e7,fname="outputs/mkg_1978_1987.pdf")
dp_plot_yrs(mkg_dec,5,yscale=2.7e7,fname="outputs/mkg_1988_1997.pdf")
dp_plot_yrs(mkg_dec,6,yscale=2.7e7,fname="outputs/mkg_1998_2007.pdf")
dp_plot_yrs(mkg_dec,7,yscale=2.7e7,fname="outputs/mkg_2008_2017.pdf")


dp_plot_yrs(tvc_dec,1,yscale=2.7e7,fname="outputs/tvc_1948_1957.pdf")
dp_plot_yrs(tvc_dec,2,yscale=2.7e7,fname="outputs/tvc_1958_1967.pdf")
dp_plot_yrs(tvc_dec,3,yscale=2.7e7,fname="outputs/tvc_1968_1977.pdf")
dp_plot_yrs(tvc_dec,4,yscale=2.7e7,fname="outputs/tvc_1978_1987.pdf")
dp_plot_yrs(tvc_dec,5,yscale=2.7e7,fname="outputs/tvc_1988_1997.pdf")
dp_plot_yrs(tvc_dec,6,yscale=2.7e7,fname="outputs/tvc_1998_2007.pdf")
dp_plot_yrs(tvc_dec,7,yscale=2.7e7,fname="outputs/tvc_2008_2017.pdf")

dp_plot_yrs(mke_dec,1,yscale=2.7e7,fname="outputs/mke_1948_1957.pdf")
dp_plot_yrs(mke_dec,2,yscale=2.7e7,fname="outputs/mke_1958_1967.pdf")
dp_plot_yrs(mke_dec,3,yscale=2.7e7,fname="outputs/mke_1968_1977.pdf")
dp_plot_yrs(mke_dec,4,yscale=2.7e7,fname="outputs/mke_1978_1987.pdf")
dp_plot_yrs(mke_dec,5,yscale=2.7e7,fname="outputs/mke_1988_1997.pdf")
dp_plot_yrs(mke_dec,6,yscale=2.7e7,fname="outputs/mke_1998_2007.pdf")
dp_plot_yrs(mke_dec,7,yscale=2.7e7,fname="outputs/mke_2008_2017.pdf")

dp_plot_yrs(grb_dec,1,yscale=2.7e7,fname="outputs/grb_1948_1957.pdf")
dp_plot_yrs(grb_dec,2,yscale=2.7e7,fname="outputs/grb_1958_1967.pdf")
dp_plot_yrs(grb_dec,3,yscale=2.7e7,fname="outputs/grb_1968_1977.pdf")
dp_plot_yrs(grb_dec,4,yscale=2.7e7,fname="outputs/grb_1978_1987.pdf")
dp_plot_yrs(grb_dec,5,yscale=2.7e7,fname="outputs/grb_1988_1997.pdf")
dp_plot_yrs(grb_dec,6,yscale=2.7e7,fname="outputs/grb_1998_2007.pdf")
dp_plot_yrs(grb_dec,7,yscale=2.7e7,fname="outputs/grb_2008_2017.pdf")

dp_plot_yrs(mdw_dec,1,yscale=2.7e7,fname="outputs/mdw_1948_1957.pdf")
dp_plot_yrs(mdw_dec,2,yscale=2.7e7,fname="outputs/mdw_1958_1967.pdf")
dp_plot_yrs(mdw_dec,3,yscale=2.7e7,fname="outputs/mdw_1968_1977.pdf")
dp_plot_yrs(mdw_dec,4,yscale=2.7e7,fname="outputs/mdw_1978_1987.pdf")
dp_plot_yrs(mdw_dec,5,yscale=2.7e7,fname="outputs/mdw_1988_1997.pdf")
dp_plot_yrs(mdw_dec,6,yscale=2.7e7,fname="outputs/mdw_1998_2007.pdf")
dp_plot_yrs(mdw_dec,7,yscale=2.7e7,fname="outputs/mdw_2008_2017.pdf")
```










